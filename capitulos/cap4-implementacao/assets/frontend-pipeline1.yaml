fsteps:
  - task: SSH@0
    displayName: "Clean build directory on VM"
    inputs:
      sshEndpoint: 'blended4future-vm'
      runOptions: 'commands'
      commands: |
        sudo rm -rf $(FRONTENDBUILDPATH)
        mkdir -p $(FRONTENDBUILDPATH)
      readyTimeout: '20000'

  - task: CopyFilesOverSSH@0
    displayName: "Copy all necessary files to VM"
    inputs:
      sshEndpoint: 'blended4future-vm'
      sourceFolder: '$(Build.SourcesDirectory)'
      contents: |
        **/*
        !node_modules/**
        !.git/**
        !cypress/**
      targetFolder: $(FRONTENDBUILDPATH)
      readyTimeout: '20000'

  - task: SSH@0
    displayName: "Move nginx.conf & Restart Nginx"
    inputs:
      sshEndpoint: 'blended4future-vm'
      runOptions: 'commands'
      failOnStdErr: false
      commands: |
        echo "Deploying nginx.conf and restarting Nginx..."
        sudo mv $(FRONTENDBUILDPATH)/nginx.conf /etc/nginx/nginx.conf
        sudo nginx -t && sudo systemctl restart nginx
      readyTimeout: '20000'

  - task: SSH@0
    displayName: "Remove Old Docker Image (optional clean)"
    continueOnError: true
    inputs:
      sshEndpoint: 'blended4future-vm'
      runOptions: 'commands'
      commands: |
        echo "Cleaning up old Docker image..."
        sudo docker rmi -f $(BUILDTAG) || true
      readyTimeout: '20000'